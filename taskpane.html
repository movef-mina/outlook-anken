<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ãƒ¡ãƒ¼ãƒ«ã«æ¡ˆä»¶ã‚’ç´ã¥ã‘</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h3 { margin-bottom: 1em; }
    label, input, select, button { display: block; margin-bottom: 12px; width: 100%; }
    #status { margin-top: 10px; color: green; }
  </style>
</head>
<body>
  <h3>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã«æ¡ˆä»¶ã‚’ç´ã¥ã‘</h3>

  <label for="æ¡ˆä»¶å">æ¡ˆä»¶åï¼š</label>
  <input type="text" id="æ¡ˆä»¶å" placeholder="ä¸€éƒ¨ã§ã‚‚å¯">

  <label for="å¯¾è±¡ä¼æ¥­">å¯¾è±¡ä¼æ¥­ï¼š</label>
  <input type="text" id="å¯¾è±¡ä¼æ¥­" placeholder="ä¸€éƒ¨ã§ã‚‚å¯">

  <label for="å¾—æ„å…ˆ">å¾—æ„å…ˆï¼š</label>
  <input type="text" id="å¾—æ„å…ˆ" placeholder="ä¸€éƒ¨ã§ã‚‚å¯">

  <button id="searchBtn">ğŸ” æ¡ˆä»¶ã‚’æ¤œç´¢</button>

  <label for="ankenSelect">æ¤œç´¢çµæœï¼š</label>
  <select id="ankenSelect">
    <option value="">æ¤œç´¢çµæœã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</option>
  </select>

  <button id="saveBtn">ğŸ“ ãƒ¡ãƒ¼ãƒ«ã«ç´ã¥ã‘ã‚‹</button>

  <div id="status"></div>

  <script>
    const powerAutomateUrl = "https://prod-12.japaneast.logic.azure.com:443/workflows/a642a7b7309646f8a6fbd4fbf9c77f4e/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Yl29bt7t-xCrd3f5PgSHvrwZXjY-qgpgjyam6ycn6c4";

    async function fetchAnkenListWithQuery(queryObj) {
      try {
        const res = await fetch(powerAutomateUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(queryObj)
        });

        const json = await res.json();
        console.log("Power Automate response:", json);
        const select = document.getElementById("ankenSelect");
        select.innerHTML = '<option value="">æ¤œç´¢çµæœã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</option>';

        const status = document.getElementById("status");

        if (!json.records || json.records.length === 0) {
          const status = document.getElementById("status");
          status.style.color = "red";
          status.textContent = "âš  æ¡ä»¶ã«åˆè‡´ã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
          return;
        }

        const count = json.totalCount ?? json.records.length;
        status.style.color = "green";
        status.textContent = `âœ… ${count}ä»¶ã®å€™è£œãŒã‚ã‚Šã¾ã™`;

        json.records.forEach(record => {
          console.log("record:", record);
          const id = record.$id?.value || "(IDãªã—)";
          const name = record.æ¡ˆä»¶å?.value || "(ç„¡é¡Œ)";
          const company = record.å¯¾è±¡ä¼æ¥­?.value || "";
          const client = record.å¾—æ„å…ˆ?.value || "";

          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `#${id}ï¼š${name}ï¼ˆ${company} / ${client}ï¼‰`;
          select.appendChild(opt);
        });
      } catch (err) {
        const status = document.getElementById("status");
        status.style.color = "red";
        status.textContent = "âŒ kintoneã‹ã‚‰æ¡ˆä»¶ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
        console.error(err);
      }
    }

    function setHeaderToMail(ankenId) {
      const status = document.getElementById("status");
      const item = Office.context.mailbox.item;

      item.internetHeaders.setAsync(
        { "X-KINTONE-ANKEN-ID": ankenId },
        function (asyncResult) {
          if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
            status.style.color = "green";
            status.textContent = `âœ… æ¡ˆä»¶ #${ankenId} ã‚’ãƒ¡ãƒ¼ãƒ«ã«ç´ã¥ã‘ã¾ã—ãŸ`;

            item.body.getAsync(Office.CoercionType.Html, function (bodyResult) {
              if (bodyResult.status === Office.AsyncResultStatus.Succeeded) {
                let currentBody = bodyResult.value || "";
                currentBody = currentBody.replace(/<[^>]+>\s*\[æ¡ˆä»¶ID:\s*.*?\]\s*<\/[^>]+>/gi, '');
                currentBody = currentBody.replace(/(<(div|p)[^>]*?>\s*(<br\s*\/?>|&nbsp;|\s)*<\/(div|p)>)+$/gi, '');
                const footerHtml = `<p style="color:gray; font-size:0.8em;">[æ¡ˆä»¶ID: ${ankenId}]</p>`;
                const updatedBody = currentBody + footerHtml;

                item.body.setAsync(updatedBody, { coercionType: Office.CoercionType.Html }, function (setResult) {
                  if (setResult.status !== Office.AsyncResultStatus.Succeeded) {
                    console.error("æœ¬æ–‡ã¸ã®è¿½è¨˜ã«å¤±æ•—:", setResult.error);
                  }
                });
              } else {
                console.error("æœ¬æ–‡ã®å–å¾—ã«å¤±æ•—:", bodyResult.error);
              }
            });

          } else {
            status.style.color = "red";
            status.textContent = "âŒ ç´ã¥ã‘ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + asyncResult.error.message;
            console.error(asyncResult.error);
          }
        }
      );
    }

    Office.onReady(() => {
      document.getElementById("searchBtn").addEventListener("click", () => {
        const name = document.getElementById("æ¡ˆä»¶å").value;
        const company = document.getElementById("å¯¾è±¡ä¼æ¥­").value;
        const client = document.getElementById("å¾—æ„å…ˆ").value;

        if (!name && !company && !client) {
          const status = document.getElementById("status");
          status.style.color = "red";
          status.textContent = "âš  æœ€ä½1ã¤ã¯å…¥åŠ›ã—ã¦ãã ã•ã„";
          return;
        }

        // Power Automate ã«ã¯ name/company/client ã‚’é€ã‚‹
        const queryObj = { name, company, client };
        fetchAnkenListWithQuery(queryObj);
      });

      document.getElementById("saveBtn").addEventListener("click", () => {
        const ankenId = document.getElementById("ankenSelect").value;
        const status = document.getElementById("status");

        if (!ankenId) {
          status.style.color = "red";
          status.textContent = "âš  æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„";
          return;
        }

        setHeaderToMail(ankenId);
      });
    });
  </script>
</body>
</html>
