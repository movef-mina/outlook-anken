<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ãƒ¡ãƒ¼ãƒ«ã«æ¡ˆä»¶ã‚’ç´ã¥ã‘</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h3 { margin-bottom: 1em; }
    label, select, button { display: block; margin-bottom: 12px; width: 100%; }
    #status { margin-top: 10px; color: green; }
  </style>
</head>
<body>
  <h3>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã«æ¡ˆä»¶ã‚’ç´ã¥ã‘</h3>

  <label for="ankenSelect">æ¡ˆä»¶ã‚’é¸æŠï¼š</label>
  <select id="ankenSelect">
    <option value="">æ¡ˆä»¶ã‚’é¸ã‚“ã§ãã ã•ã„</option>
  </select>

  <button id="saveBtn">ğŸ“ ãƒ¡ãƒ¼ãƒ«ã«ç´ã¥ã‘ã‚‹</button>

  <div id="status"></div>

  <script>
    const kintoneSubdomain = "nbgl9";
    const kintoneAppId = 5;
    const apiToken = "JXlxEnsGgUqmhKmNYr7JIJyChOCVpT5ZZ1QPjlA9";

    // æ¡ˆä»¶ä¸€è¦§ã‚’å–å¾—ï¼ˆãƒ¬ã‚³ãƒ¼ãƒ‰ç•ªå·é™é †ï¼‰
    async function fetchAnkenList() {
      const url = `https://${kintoneSubdomain}.cybozu.com/k/v1/records.json` +
                  `?app=${kintoneAppId}` +
                  `&fields=æ¡ˆä»¶å,å¯¾è±¡ä¼æ¥­,å¾—æ„å…ˆ` +
                  `&query=order by $id desc limit 100`;

      try {
        const res = await fetch(url, {
          method: "GET",
          headers: {
            "X-Cybozu-API-Token": apiToken,
            "Content-Type": "application/json"
          }
        });

        const json = await res.json();
        const select = document.getElementById("ankenSelect");

        json.records.forEach(record => {
          const id = record.$id.value;
          const name = record.æ¡ˆä»¶å.value || "(ç„¡é¡Œ)";
          const company = record.å¯¾è±¡ä¼æ¥­.value || "";
          const client = record.å¾—æ„å…ˆ.value || "";

          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = `#${id} ${name}ï¼ˆ${client} / ${company}ï¼‰`;
          select.appendChild(opt);
        });
      } catch (err) {
        const status = document.getElementById("status");
        status.style.color = "red";
        status.textContent = "âŒ kintoneã‹ã‚‰æ¡ˆä»¶ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
        console.error(err);
      }
    }

    // æ¡ˆä»¶IDã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã«ä¿å­˜
    function setHeaderToMail(ankenId) {
      const status = document.getElementById("status");
      const item = Office.context.mailbox.item;

      item.internetHeaders.setAsync(
        { "X-KINTONE-ANKEN-ID": ankenId },
        function (asyncResult) {
          if (asyncResult.status === Office.AsyncResultStatus.Succeeded) {
            status.style.color = "green";
            status.textContent = `âœ… æ¡ˆä»¶ #${ankenId} ã‚’ãƒ¡ãƒ¼ãƒ«ã«ç´ã¥ã‘ã¾ã—ãŸ`;
          } else {
            status.style.color = "red";
            status.textContent = "âŒ ç´ã¥ã‘ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + asyncResult.error.message;
            console.error(asyncResult.error);
          }
        }
      );
    }

    Office.onReady(() => {
      fetchAnkenList();

      document.getElementById("saveBtn").addEventListener("click", () => {
        const ankenId = document.getElementById("ankenSelect").value;
        const status = document.getElementById("status");

        if (!ankenId) {
          status.style.color = "red";
          status.textContent = "âš  æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„";
          return;
        }

        setHeaderToMail(ankenId);
      });
    });
  </script>
</body>
</html>
